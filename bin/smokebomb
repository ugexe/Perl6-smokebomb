#!/bin/bash

echo "***SMOKE-BOMB***"
BREWPATH=${1:-"${HOME}/.rakudobrew"}
BREWBIN="${BREWPATH}/bin"
RAKUDOBREW="${BREWBIN}/rakudobrew"
P6="${BREWBIN}/perl6"
VMS=(moar jvm)
SKIP="panda,DateTime::TimeZone"

if [ ! -f "${RAKUDOBREW}" ]; then
    echo "bin/rakudobrew not found in path: ${BREWPATH}"
    echo "-- Installing rakudobrew to: ${BREWPATH}"
    `git clone https://github.com/tadzik/rakudobrew $BREWPATH`
fi

for VM in "${VMS[@]}"; do
    if [[ `$RAKUDOBREW build $VM` ]]; then
        if [[ `$RAKUDOBREW switch $VM` ]]; then
            P6V=`$P6 -v`

            shopt -s nocasematch
            if [[ $P6V =~ $VM ]]; then
                if [[ `$RAKUDOBREW build-panda` ]]; then
                    `PANDA_SUBMIT_TESTREPORTS=1 panda smoke --exclude=$SKIP`
                else
                    echo "FAILED; Module installer, panda, failed to install: $RAKUDOBREW build-panda"
                fi
            else
                echo "FAILED; Failed to switch to correct VM: '${P6V}' =~ ${VM}"
            fi
            shopt -u nocasematch

        else
            echo "FAILED; Problem with VM switching command: $RAKUDOBREW switch ${VM}"
        fi
    else
        echo "FAILED; Problem building the VM: $RAKUDOBREW build ${VM}"
    fi
done
