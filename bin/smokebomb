#!/bin/bash

echo "***SMOKE-BOMB***"
BREWPATH=${1:-"${HOME}/.rakudobrew"}
BREWBIN="${BREWPATH}/bin"
RAKUDOBREW="${BREWBIN}/rakudobrew"
P6="${BREWBIN}/perl6"
VMS=(moar jvm)
SKIP="panda,DateTime::TimeZone"

if [ ! -f "${RAKUDOBREW}" ]; then
    echo "bin/rakudobrew not found in path: ${BREWPATH}"
    echo "-- Installing rakudobrew to: ${BREWPATH}"
    `git clone https://github.com/tadzik/rakudobrew $BREWPATH`
fi
export PATH="$BREWBIN:$PATH"

for VM in "${VMS[@]}"; do
     echo "**Building VM: $VM"
    if [[ `$RAKUDOBREW build $VM` ]]; then
        if [[ `$RAKUDOBREW switch $VM` ]]; then
            P6V=`$P6 -v`
            echo "*perl6 -v: $P6V"
            echo "**Building panda..."

            if [ -d "$BREWPATH/panda" ]; then
               (cd "$BREWPATH/panda" && git pull)
            else
                `git clone git://github.com/tadzik/panda.git $BREWPATH/panda`
            fi
            (cd "$BREWPATH/panda" && $P6 bootstrap.pl)
            (cp "$BREWPATH/panda/bin/panda" "$BREWBIN")

            echo "**Starting smoke testing..."
            `PANDA_SUBMIT_TESTREPORTS=1 "$BREWBIN/panda" smoke --exclude=$SKIP`
        else
            echo "FAILED; Problem with VM switching command: $RAKUDOBREW switch ${VM}"
        fi
    else
        echo "FAILED; Problem building the VM: $RAKUDOBREW build ${VM}"
    fi
done
